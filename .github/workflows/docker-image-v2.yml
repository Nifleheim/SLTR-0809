name: "Docker Build Push"
description: "Build and push Docker image"

branding:
  icon: "upload-cloud"
  color: "blue"
author: "Ross MacLean"

on:
  push:
    branches: ['main']

inputs:
  docker-user:
    description: "Docker user to use when uploading container"
    required: true
  image-name:
    description: "simpleapptest"
    required: true
  dockerhub-token:
    description: "Dockerhub token"
    required: true
  version:
    description: "1.0.1"
    required: true

jobs:
    push_to_registry:
      name: Build and Push Docker image to Docker Hub
      runs-on: ubuntu-latest
      using: composite
      steps:
        - name: Print version
          run: echo "Version ${{ inputs.version }}"
          shell: bash
        - name: Set up QEMU
          uses: docker/setup-qemu-action@v2
        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v2
        - name: Login to Docker Hub
          uses: docker/login-action@v2
          with:
            username: ${{ secrets.DOCKER-USERNAME }}
            password: ${{ secrets.DOCKER-PASSWORD }}
        - name: Docker build
          run: "docker build -t ${{ secrets.DOCKER-USERNAME }}/${{ inputs.image-name }}:${{ inputs.version }} -t ${{ secrets.DOCKER-USERNAME }}/${{ inputs.image-name }}:latest ."
          shell: bash
        - name: Docker push
          run: docker push --all-tags ${{ secrets.DOCKER-USERNAME }}/${{ inputs.image-name }}
          shell: bash
